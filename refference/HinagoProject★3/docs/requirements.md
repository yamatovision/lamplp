# ボリュームチェックシステム 要件定義書

**バージョン**: 1.3.0  
**最終更新日**: 2025-05-14  
**ステータス**: ドラフト  

## 1. プロジェクト概要

### 1.1 目的と背景

福岡市を中心に31年の歴史を持つディベロッパー企業向けの、土地購入意思決定支援システムです。近年の福岡市内における土地不足により、良質な投資用地をめぐる競争が激化しています。これにより、土地購入判断における迅速性と正確性の両立が経営上の課題となっています。

本システムは、建築基準法や都市計画法に基づいた最大建築可能ボリュームの自動算出を中心とした機能を提供し、現在属人的に行われている土地購入判断プロセスを迅速化します。特に3Dモデルによる視覚的な把握と容積消化率の最適化により、投資効率の高い判断を支援します。

### 1.2 ターゲットユーザー

- **不動産ディベロッパー経営者**: 最終的な投資判断を行う意思決定者
- **用地仕入れ担当者**: 土地情報を収集・分析し、購入候補を選定する担当者
- **設計・企画担当者**: 土地に対する建築計画を立案する担当者

### 1.3 核となる機能と価値

以下は、プロジェクトの本質的価値を提供するために「絶対に必要」な機能です。各機能は「この機能がないとプロジェクトの目的達成が不可能になる」という基準で厳選されています。

- **建築基準法に基づく最大ボリュームチェック機能**: 敷地情報と法規制に基づいた最大建築可能ボリュームを自動算出 - *この機能がないと土地の最大活用可能性が不明確となり、投資判断の基礎が欠如する*
- **測量図アップロードと土地形状読み込み機能**: 不整形な土地の形状を正確に反映し、現実的な建築可能ボリュームを算出 - *この機能がないと長方形や正方形以外の土地形状に対応できず、正確な計算結果が得られない*
- **シンプルな箱型3Dモデル生成機能**: 算出された建築ボリュームを視覚的に表現し直感的な理解を促進 - *この機能がないと空間的な把握が困難となり、実現性の判断が不正確になる*
- **容積消化率の自動計算機能**: アセットタイプ（マンション、木造アパート等）に応じた容積消化率を算出 - *この機能がないと現実的な建築計画ベースでの収益性判断ができず、投資効率が不明確になる*



## 2. 画面一覧

このアプリケーションは以下の画面要素と実際のページで構成されます。各ページのモックアップは作成後に詳細化されます。

### 2.1 画面要素一覧

以下は機能的に必要な全ての画面要素です。これらは必ずしも独立したページとして実装されるわけではありません。

| 画面要素名 | 目的 | 実現する核心的価値 |
|----------|------|----------------|
| ログイン要素 | ユーザー認証 | セキュリティ確保 |
| ユーザー管理要素 | ユーザー情報の管理と権限制御 | 組織内アクセス制御とユーザー体験の個人化 |
| 組織管理要素 | 組織情報と設定の管理 | 企業リソースの一元管理とガバナンス確保 |
| 敷地情報入力要素 | 対象土地の基本情報登録 | 正確なデータ入力基盤の確保 |
| 測量図アップロード要素 | 土地の正確な形状情報の取得 | 不整形地に対応した正確な計算基盤の確保 |
| アセットタイプ選択要素 | 建物種別の選択 | 現実的な建築プラン策定 |
| ボリュームチェック要素 | 建築可能ボリュームの自動算出表示 | 最大建築可能規模の可視化 |
| 3D表示要素 | 生成された建築ボリュームの3D表示 | 空間的な把握と直感的理解 |
| 容積消化率表示要素 | 選択アセットタイプの容積消化率表示 | 実現可能な建築ボリュームの効率評価 |
| PDF出力要素 | 分析結果のPDFレポート生成 | 関係者間での情報共有と会議資料作成 |
| 案件一覧要素 | 登録済み案件の一覧表示と管理 | 複数案件の比較と進捗管理 |

### 2.2 ページ構成計画

上記の画面要素を、ユーザー体験とナビゲーション効率を最適化するために以下のように統合・構成します。必要に応じてサブシステム別にページをグループ化して示します。

#### 2.2.1 共通ページ

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| P-001 | ログインページ | ユーザー認証 | ログイン要素 | 高 | [login.html](/mockups/login.html) | 実装済み |
| P-002 | 登録ページ | ユーザー登録 | ログイン要素 | 高 | - | 実装済み |
| P-003 | パスワードリセットページ | パスワード回復 | ログイン要素 | 高 | - | 実装済み |
| P-004 | ダッシュボード | 全体概況と案件一覧 | 案件一覧要素 | 高 | [dashboard.html](/mockups/dashboard.html) | 未着手 |

#### 2.2.2 ユーザー・組織管理サブシステム

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| S1-001 | 管理ダッシュボード | 管理機能へのアクセス提供 | 管理メニュー、統計サマリー | 高 | - | 未着手 |
| S1-002 | ユーザー一覧ページ | 組織内ユーザー表示・管理 | ユーザー一覧テーブル、フィルター、検索 | 高 | - | 未着手 |
| S1-003 | ユーザー詳細ページ | ユーザー情報の表示・編集 | ユーザープロフィール、編集フォーム | 中 | - | 未着手 |
| S1-004 | ユーザー作成ページ | 新規ユーザー追加 | ユーザー作成フォーム | 中 | - | 未着手 |
| S1-005 | マイプロフィールページ | 自分のプロフィール管理 | プロフィール情報、編集フォーム | 高 | - | 未着手 |
| S1-006 | 組織詳細ページ | 組織情報の表示・編集 | 組織プロフィール、編集フォーム | 高 | - | 未着手 |
| S1-007 | 組織設定ページ | 組織設定の管理 | 設定フォーム、サブスクリプション情報 | 中 | - | 未着手 |

#### 2.2.3 物件管理サブシステム

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| S2-001 | 物件登録ページ | 新規物件情報の登録 | 敷地情報入力要素、測量図アップロード要素 | 高 | [property-register.html](/mockups/property-register.html) | 未着手 |
| S2-002 | 物件詳細ページ | 登録済み物件の詳細表示と編集 | 敷地情報入力要素、測量図アップロード要素 | 中 | 未作成 | 未着手 |

#### 2.2.4 分析サブシステム

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| S3-001 | ボリュームチェックページ | 建築可能ボリュームの算出と表示 | 敷地情報入力要素、測量図アップロード要素、アセットタイプ選択要素、ボリュームチェック要素、3D表示要素、容積消化率表示要素、PDF出力要素 | 最高 | [volume-check.html](/mockups/volume-check.html) | 未着手 |
| S3-002 | 収益性試算ページ | 事業収支の試算と分析 | 敷地情報入力要素、アセットタイプ選択要素、ボリュームチェック要素、収益性試算要素 | 高 | [profitability-analysis.html](/mockups/profitability-analysis.html) | 未着手 |

### 2.3 画面フロー

サブシステムごとのナビゲーションフローを示します。

#### 2.3.1 認証フロー
```
[ログインページ] → [認証成功時、ダッシュボードへリダイレクト]
[登録ページ] → [登録成功時、ログインページへリダイレクト]
[パスワードリセットページ] → [リセット成功時、ログインページへリダイレクト]
```

#### 2.3.2 ユーザー・組織管理フロー
```
[ダッシュボード] → [管理ダッシュボード]
                   └── [ユーザー管理] → [ユーザー一覧] → [ユーザー詳細]
                                      └── [ユーザー作成]
                   └── [組織管理] → [組織詳細]
                                 └── [組織設定]
[ヘッダーメニュー] → [マイプロフィール]
```

#### 2.3.3 物件登録フロー
```
[ダッシュボード] → [物件登録ページ] → [測量図アップロード] → [登録完了後、ボリュームチェックページまたはダッシュボードへ]
```

#### 2.3.4 分析フロー
```
[ダッシュボード] → [物件選択] → [ボリュームチェックページ] → [必要に応じて収益性試算ページ]
```

## 3. ページ詳細

このセクションでは、各サブシステムに含まれるページの詳細と、それらに含まれる画面要素について説明します。

### 3.1 共通ページ

#### 3.1.1 ログインページ (P-001)
**モックアップ**: [login.html](/mockups/login.html)

**ページ概要**: ユーザー認証を行い、権限に応じたシステム機能へのアクセスを提供します。シンプルで使いやすいデザインにより、スムーズなユーザー体験を実現します。

**含まれる画面要素**:
- ログインフォーム: メールアドレスとパスワードによる認証フォーム
- パスワード表示切替: パスワードの可視性をトグルするアイコンボタン
- ログイン状態保持: ユーザーセッションを保持するためのチェックボックス
- パスワードリカバリーリンク: パスワード忘れ時のリカバリーページへのリンク
- アカウント登録リンク: 新規ユーザー登録ページへのリンク

**状態と動作**:
- 初期状態: ログインフォームの表示
- バリデーション状態: 入力内容の検証とエラーメッセージ表示
- エラー状態: 認証失敗時のエラーメッセージ表示
- 成功状態: ダッシュボードへリダイレクト
- パスワード非表示/表示: パスワードの可視性切替

**UI最適化ポイント**:
- シンプルで直感的なフォームレイアウト
- 目立つログインボタン
- リアルタイムバリデーションによるユーザーフィードバック
- モバイル対応のレスポンシブデザイン
- 集中しやすいカード型UIデザイン

**データとAPI**:
- `POST /api/auth/login` → ユーザー認証
  - リクエスト: { email: string, password: string, rememberMe?: boolean }
  - 成功: { token: string, user: UserData }
  - エラー: 401 Unauthorized

#### 3.1.2 ダッシュボード (P-002)

**ページ概要**: システムのメインハブとして機能し、登録済み物件一覧と主要機能へのアクセスを提供します。

**含まれる画面要素**:
- 案件一覧要素: 登録済み物件の一覧表示とフィルタリング機能
- クイックアクション要素: よく使う機能へのショートカット

**状態と動作**:
- 初期状態: 登録済み物件一覧の表示
- フィルタ状態: 条件によるフィルタリング結果の表示
- アクション状態: 選択物件に対する操作メニューの表示

**データとAPI**:
- `GET /api/properties` → 物件一覧取得
  - リクエスト: { filters?: FilterOptions }
  - 成功: { properties: Property[] }
  - エラー: 403 Forbidden

### 3.2 物件管理サブシステム

#### 3.2.1 物件登録ページ (S1-001)
**モックアップ**: [property-register.html](/mockups/property-register.html)

**ページ概要**: 新規物件情報を登録するためのインターフェースを提供します。シンプルでクリーンなUI設計により、データ入力の効率性と正確性を両立しています。

**含まれる画面要素**:
- 敷地情報入力要素: 物件基本情報の入力フォーム（住所、敷地面積、用途地域、防火地域区分、日影規制、建蔽率、容積率、許容建築面積）
- 測量図アップロード要素: 測量図のアップロードと土地形状の自動/手動設定機能
- 地図プレビュー要素: 住所から自動生成される地図表示
- 折りたたみ可能な詳細規制情報セクション: 情報過多による認知負荷を軽減するUI

**状態と動作**:
- 初期状態: 空の登録フォームと必須項目の表示
- 入力状態: 物件情報入力中の状態。自動計算機能による即時フィードバック（許容建築面積や坪単価）
- 測量図アップロード状態: 測量図のアップロードと形状抽出処理中
- 形状調整状態: 抽出された土地形状の確認・調整
- 検証状態: 入力データのバリデーション結果表示
- 完了状態: 登録完了確認と次ステップへの誘導

**UI最適化ポイント**:
- 必須項目と任意項目の明確な区別（必須項目にはアスタリスク表示）
- セクション分割による情報の構造化（基本情報、法規制情報、備考・メモ）
- 詳細情報の折りたたみ表示による認知負荷の低減
- リアルタイム計算による即時フィードバック（許容建築面積や坪単価の自動計算）
- モバイル対応のレスポンシブデザイン

**データとAPI**:
- `POST /api/properties` → 新規物件登録
  - リクエスト: { propertyData: PropertyCreateData, shapeData?: ShapeData }
  - 成功: { property: Property }
  - エラー: 400 Bad Request
- `POST /api/properties/upload-survey` → 測量図アップロード
  - リクエスト: FormData (file: File)
  - 成功: { shapeData: ShapeData }
  - エラー: 400 Bad Request
- `GET /api/geocode` → 住所から緯度経度情報取得
  - リクエスト: { address: string }
  - 成功: { lat: number, lng: number, formatted_address: string }
  - エラー: 400 Bad Request

#### 3.2.2 物件詳細ページ (S1-002)
**モックアップ**: [property-detail.html](/mockups/property-detail.html)

**ページ概要**: 登録済み物件の詳細表示と編集を提供します。タブインターフェースにより、基本情報、敷地形状、図面・資料、更新履歴などを効率的に管理できます。

**含まれる画面要素**:
- 敷地情報入力要素: 物件基本情報の入力/編集フォーム（物件名、住所、敷地面積、用途地域など）
- 測量図アップロード要素: 測量図のアップロードと土地形状の設定機能
- 敷地形状エディタ: 境界点座標の表示と編集機能
- 資料管理要素: 関連図面や書類のアップロード、表示、ダウンロード機能
- タグ管理要素: 物件の特性をタグとして管理する機能
- 更新履歴表示要素: 物件情報の変更履歴を時系列で表示

**状態と動作**:
- 初期状態: 既存物件情報をタブ形式で表示
- 編集状態: 物件情報の編集中状態。リアルタイム計算による即時フィードバック
- 測量図アップロード状態: 測量図のアップロードと形状抽出処理中
- 形状調整状態: 抽出された土地形状の確認・調整
- 資料管理状態: 関連図面や書類の追加、削除、プレビュー
- 保存状態: 編集内容の検証と保存完了確認

**UI最適化ポイント**:
- タブインターフェースによる情報の整理（基本情報、敷地形状、図面・資料、更新履歴）
- ステータスバッジによる物件状態の視覚的表現
- 必須項目と任意項目の明確な区別
- 敷地形状の視覚的表現と編集
- 関連資料の一元管理とプレビュー機能
- 更新履歴の時系列表示による変更追跡
- モバイル対応のレスポンシブデザイン

**データとAPI**:
- `GET /api/properties/:id` → 物件詳細取得
  - リクエスト: { id: string }
  - 成功: { property: PropertyDetail }
  - エラー: 404 Not Found
- `PUT /api/properties/:id` → 物件情報更新
  - リクエスト: { id: string, propertyData: PropertyUpdateData }
  - 成功: { property: PropertyDetail }
  - エラー: 400 Bad Request
- `POST /api/properties/:id/documents` → 資料アップロード
  - リクエスト: FormData (file: File)
  - 成功: { document: Document }
  - エラー: 400 Bad Request
- `GET /api/properties/:id/history` → 更新履歴取得
  - リクエスト: { id: string, limit?: number }
  - 成功: { history: HistoryEntry[] }
  - エラー: 404 Not Found

### 3.3 ユーザー・組織管理サブシステム

#### 3.3.1 管理ダッシュボード (S1-001)

**ページ概要**: システムの管理機能へのアクセスを提供するハブ。組織の概要統計や重要な指標を表示します。

**含まれる画面要素**:
- 管理メニュー: ユーザー管理、組織管理などへのリンク
- 統計サマリー: ユーザー数、プロジェクト数、ストレージ使用量などの指標
- 最近のアクティビティ: 最近の変更や操作の履歴
- クイックアクションボタン: よく使う機能へのショートカット

**データとAPI**:
- `GET /api/users/stats` → ユーザー統計情報取得
- `GET /api/organizations/{id}` → 組織詳細情報取得

#### 3.3.2 ユーザー一覧ページ (S1-002)

**ページ概要**: 組織内のすべてのユーザーを一覧表示し、管理操作を提供します。

**含まれる画面要素**:
- ユーザー一覧テーブル: 名前、メール、役割、最終ログイン日時などを表示
- 検索・フィルター機能: ユーザー名やメールで検索、役割でフィルタリング
- ソート機能: 名前、登録日などでソート
- アクションボタン: 詳細表示、編集、無効化などの操作
- 新規ユーザー追加ボタン: ユーザー作成ページへ誘導

**データとAPI**:
- `GET /api/users` → 組織内ユーザー一覧取得

#### 3.3.3 ユーザー詳細ページ (S1-003)

**ページ概要**: 特定ユーザーの詳細情報を表示し、編集機能を提供します。

**含まれる画面要素**:
- ユーザープロフィール表示: 名前、メール、役割、所属チームなど
- 権限情報表示: 現在の権限とアクセスレベル
- 活動履歴: ログイン履歴やシステム操作履歴
- 編集フォーム: プロフィール情報の編集機能
- パスワードリセット: 管理者によるパスワードリセット機能

**データとAPI**:
- `GET /api/users/{id}` → ユーザー詳細情報取得
- `PUT /api/users/{id}` → ユーザー情報更新

#### 3.3.4 ユーザー作成ページ (S1-004)

**ページ概要**: 新規ユーザーを組織に追加するためのフォームを提供します。

**含まれる画面要素**:
- ユーザー作成フォーム: 名前、メール、初期パスワード、役割などの入力フィールド
- バリデーション: 入力値の検証と即時フィードバック
- 権限設定: 初期権限の設定オプション
- 招待メールオプション: ユーザーに招待メールを送信するオプション

**データとAPI**:
- `POST /api/users` → 新規ユーザー作成

#### 3.3.5 マイプロフィールページ (S1-005)

**ページ概要**: ログインユーザー自身のプロフィール表示と編集機能を提供します。

**含まれる画面要素**:
- プロフィール情報表示: 名前、メール、役割、アカウント情報
- 編集フォーム: 自分のプロフィール情報を編集
- パスワード変更: 現在のパスワード確認と新パスワード設定
- 通知設定: メール通知などの設定オプション
- セッション管理: アクティブなセッションの表示と管理

**データとAPI**:
- `GET /api/users/profile` → 自分のプロフィール情報取得
- `PUT /api/users/profile` → 自分のプロフィール情報更新

#### 3.3.6 組織詳細ページ (S1-006)

**ページ概要**: 組織の詳細情報を表示し、基本情報の編集機能を提供します。

**含まれる画面要素**:
- 組織プロフィール表示: 組織名、設立日、ロゴ、連絡先など
- 統計情報: ユーザー数、リソース使用量、活動指標など
- 編集フォーム: 組織基本情報の編集機能
- 組織構造表示: 部門やチームの構造（将来拡張用）

**データとAPI**:
- `GET /api/organizations/{id}` → 組織詳細情報取得
- `PUT /api/organizations/{id}` → 組織情報更新

#### 3.3.7 組織設定ページ (S1-007)

**ページ概要**: 組織のシステム設定、サブスクリプション管理、利用容量確認などを提供します。

**含まれる画面要素**:
- サブスクリプション情報: 現在のプラン、支払い状況、更新日など
- 使用量表示: ストレージ使用量、ユーザー数制限との比較
- 設定フォーム: システム設定、デフォルト値、ブランディングなどの設定
- アクセス制御設定: 組織全体のセキュリティ設定（将来拡張用）

**データとAPI**:
- `GET /api/organizations/{id}/settings` → 組織設定情報取得
- `PUT /api/organizations/{id}/settings` → 組織設定更新

### 3.4 物件管理サブシステム

#### 3.4.1 物件登録ページ (S2-001)

**ページ概要**: 建築基準法を考慮した最大建築可能ボリュームを自動算出し視覚化します。アセットタイプ選択により容積消化率も表示します。

**含まれる画面要素**:
- 敷地情報入力要素: 物件基本情報の入力/編集フォーム
- 測量図アップロード要素: 測量図のアップロードと土地形状の設定機能
- アセットタイプ選択要素: マンション、木造アパート、オフィスなどの選択ボタン
- ボリュームチェック要素: 建築条件の設定と自動計算機能
- 3D表示要素: 計算結果の3Dビジュアライゼーション（箱型モデル）
- 容積消化率表示要素: 選択アセットタイプに基づく容積消化率の表示
- PDF出力要素: 分析結果のPDF出力機能

**状態と動作**:
- 初期状態: 基本パラメータ入力フォームの表示
- 測量図アップロード状態: 測量図のアップロードと形状抽出処理中
- 形状調整状態: 抽出された土地形状の確認・調整
- 計算中状態: 処理進行状況インジケータの表示
- 結果表示状態: 算出結果と3Dビューの表示
- 編集状態: パラメータ変更による再計算と結果更新

**データとAPI**:
- `POST /api/analysis/volume-check` → ボリュームチェック実行
  - リクエスト: { propertyId: string, buildingParams: BuildingParams, assetType: string }
  - 成功: { volumeResult: VolumeCheckResult, consumptionRate: number, model3d: Model3DData }
  - エラー: 400 Bad Request
- `POST /api/properties/upload-survey` → 測量図アップロード
  - リクエスト: FormData (file: File)
  - 成功: { shapeData: ShapeData }
  - エラー: 400 Bad Request
- `PUT /api/properties/:id/shape` → 土地形状の手動更新
  - リクエスト: { id: string, shapeData: ShapeData }
  - 成功: { property: PropertyDetail }
  - エラー: 400 Bad Request

#### 3.4.2 物件詳細ページ (S2-002)

### 3.5 分析サブシステム

#### 3.5.1 ボリュームチェックページ (S3-001)

**ページ概要**: 建築基準法を考慮した最大建築可能ボリュームを自動算出し視覚化します。アセットタイプ選択により容積消化率も表示します。

**含まれる画面要素**:
- 敷地情報入力要素: 物件基本情報の入力/編集フォーム
- 測量図アップロード要素: 測量図のアップロードと土地形状の設定機能
- アセットタイプ選択要素: マンション、木造アパート、オフィスなどの選択ボタン
- ボリュームチェック要素: 建築条件の設定と自動計算機能
- 3D表示要素: 計算結果の3Dビジュアライゼーション（箱型モデル）
- 容積消化率表示要素: 選択アセットタイプに基づく容積消化率の表示
- PDF出力要素: 分析結果のPDF出力機能

**状態と動作**:
- 初期状態: 基本パラメータ入力フォームの表示
- 測量図アップロード状態: 測量図のアップロードと形状抽出処理中
- 形状調整状態: 抽出された土地形状の確認・調整
- 計算中状態: 処理進行状況インジケータの表示
- 結果表示状態: 算出結果と3Dビューの表示
- 編集状態: パラメータ変更による再計算と結果更新

**データとAPI**:
- `POST /api/analysis/volume-check` → ボリュームチェック実行
  - リクエスト: { propertyId: string, buildingParams: BuildingParams, assetType: string }
  - 成功: { volumeResult: VolumeCheckResult, consumptionRate: number, model3d: Model3DData }
  - エラー: 400 Bad Request
- `POST /api/properties/upload-survey` → 測量図アップロード
  - リクエスト: FormData (file: File)
  - 成功: { shapeData: ShapeData }
  - エラー: 400 Bad Request
- `PUT /api/properties/:id/shape` → 土地形状の手動更新
  - リクエスト: { id: string, shapeData: ShapeData }
  - 成功: { property: PropertyDetail }
  - エラー: 400 Bad Request

#### 3.5.2 収益性試算ページ (S3-002)
**モックアップ**: [profitability-analysis.html](/mockups/profitability-analysis.html)

**ページ概要**: ボリュームチェック結果に基づき、事業収支を自動試算します。複数シナリオの比較分析が可能で、投資判断に必要な財務指標を提供します。

**含まれる画面要素**:
- 敷地情報要素: 物件基本情報の表示（非編集）
- ボリュームチェック要素: 建築ボリューム結果の表示（非編集）
- アセットタイプ選択要素: マンション、木造アパート、オフィスなどの選択ボタン
- 収益性パラメータ設定要素: 収益性試算のための詳細パラメータ設定（賃料単価、稼働率、建設単価など）
- シナリオ管理要素: 複数シナリオの作成・比較機能
- 結果表示要素: 投資利回り、IRR、NPV、投資回収期間などの財務指標
- グラフ表示要素: キャッシュフロー推移と感度分析のグラフ
- PDF出力要素: 分析結果のPDF出力機能

**状態と動作**:
- 初期状態: 基本パラメータ入力フォームとボリュームチェック結果の表示
- パラメータ調整状態: スライダーによる収益パラメータの直感的調整
- シナリオ切替状態: 複数シナリオ間の切り替えと比較
- 計算中状態: 処理進行状況インジケータの表示
- 結果表示状態: 収支計算結果の表・グラフ表示
- 編集状態: パラメータ変更による再計算と結果更新

**UI最適化ポイント**:
- スライダーによる直感的なパラメータ調整
- 即時フィードバックによる影響の可視化
- シナリオタブによる複数ケースの簡単な比較
- 階層化された情報表示（カードとタブの組み合わせ）
- 視覚的に理解しやすいデータグラフと指標表示
- モバイル対応のレスポンシブデザイン

**データとAPI**:
- `POST /api/analysis/profitability` → 収益性試算実行
  - リクエスト: { propertyId: string, volumeId: string, assetType: string, financialParams: FinancialParams }
  - 成功: { profitabilityResult: ProfitabilityResult }
  - エラー: 400 Bad Request
- `POST /api/analysis/scenarios` → シナリオ保存
  - リクエスト: { propertyId: string, name: string, params: ScenarioParams }
  - 成功: { scenario: Scenario }
  - エラー: 400 Bad Request
- `GET /api/analysis/scenarios` → シナリオ一覧取得
  - リクエスト: { propertyId: string }
  - 成功: { scenarios: Scenario[] }
  - エラー: 404 Not Found

## 4. 共通コンポーネント

| ID | コンポーネント名 | 用途 | 使用ページ | 参照 |
|----|--------------|------|----------|------|
| C-001 | ヘッダーナビゲーション | 全画面共通のナビゲーションバー | 全ページ | - |
| C-002 | 物件選択ドロップダウン | 登録済み物件からの選択UI | ダッシュボード、分析ページ群 | - |
| C-003 | 測量図アップローダー | 測量図のアップロードと形状抽出 | 物件登録ページ、ボリュームチェックページ | - |
| C-004 | 土地形状エディタ | 土地形状の手動調整インターフェース | 物件登録ページ、ボリュームチェックページ | - |
| C-005 | 3Dビューアコンポーネント | 建築ボリュームの3D表示 | ボリュームチェックページ | - |
| C-006 | 容積消化率インジケータ | 容積消化率の視覚的表示 | ボリュームチェックページ | - |
| C-007 | アセットタイプセレクタ | 建物種別の選択UI | ボリュームチェックページ、収益性試算ページ | - |
| C-008 | パラメータスライダー | 収益性パラメータの直感的調整 | 収益性試算ページ | - |
| C-009 | シナリオタブシステム | 複数シナリオの保存と切替 | 収益性試算ページ | - |
| C-010 | データメトリクスカード | 主要指標のカード表示 | 収益性試算ページ、ボリュームチェックページ | - |

## 5. データモデル概要

データモデルの詳細は `docs/data_models.md` で定義されています。すべての型定義は `shared/index.ts` で一元管理され、フロントエンドとバックエンドで共有されます。

### 5.1 エンティティ関連図

```
User (ユーザー) <--> Organization (組織)
        |                 |
        v                 v
      Property (物件)
        |
        +------------+------------+
        |            |            |
        v            v            v
  PropertyShape  VolumeCheck   Document
  (敷地形状)    (ボリュームチェック)  (文書)
                    |
                    v
                 Scenario
                (シナリオ)
                    |
                    v
              ProfitabilityResult
              (収益性試算結果)
```

### 5.2 主要エンティティ

| エンティティ | 主な属性 | 関連エンティティ | 備考 |
|------------|----------|----------------|------|
| User | id, email, name, role | Organization | 認証・認可情報 |
| Organization | id, name, subscription | User, Property | 企業アカウント情報 |
| Property | id, name, address, area, zoneType, fireZone, shadowRegulation, buildingCoverage, floorAreaRatio, allowedBuildingArea, shapeData, price, status, notes | Organization, VolumeCheck, Document | 物件基本情報 |
| PropertyShape | points, width, depth, sourceFile | Property | 土地形状情報 |
| VolumeCheck | id, propertyId, assetType, buildingArea, totalFloorArea, buildingHeight, consumptionRate, floors, model3dData, createdAt | Property | ボリュームチェック結果 |
| Scenario | id, propertyId, volumeCheckId, name, params, profitabilityResult, createdAt | Property, VolumeCheck | 収益性試算シナリオ |
| ProfitabilityResult | id, propertyId, volumeCheckId, assetType, parameters, landPrice, constructionCost, miscExpenses, totalInvestment, annualRentalIncome, annualOperatingExpenses, annualMaintenance, annualPropertyTax, annualNOI, noiYield, irr, paybackPeriod, npv, annualFinancials, createdAt | Property, VolumeCheck | 収益性試算結果 |
| Document | id, propertyId, name, fileType, fileSize, fileUrl, documentType, description | Property | 文書情報 |

## 6. 特記すべき非機能要件

以下は標準的な実装方針から特に注意すべき点です：

- **計算処理の応答性**: ボリュームチェックなど計算負荷の高い処理についても、10秒以内の応答を目標とします
- **3D表示の軽量性**: 3Dビューアはモバイルデバイスを含む様々な環境でも動作する軽量な実装が必要です
- **建築基準法の正確な反映**: 福岡市の建築基準法規制を正確に計算に反映させる必要があります
- **測量図解析の精度**: 一般的なPDFや画像形式の測量図から正確に土地形状を抽出する精度が重要です
- **形状編集のユーザビリティ**: 複雑な土地形状も直感的に編集できるインターフェースが必要です
- **PDF出力の品質**: 出力されるPDFは印刷用途にも適した高品質なものである必要があります

## 6.1 技術的実装方針

### 6.1.1 3Dモデル表示技術

**フェーズ1（初期実装）: Three.js**
- 軽量かつシンプルな3Dモデル表示に最適
- 多くのデバイスでの互換性確保
- 基本的な箱型ボリューム表示と敷地形状表現に適している
- モバイルデバイスを含む様々な環境での動作を保証

**フェーズ2（拡張）: Cesiumへの段階的移行検討**
- 地理情報と連携した高品質な3D表示
- 地形データや周辺建物との関係性表現
- 厳密な緯度経度ベースでの配置と計算
- プレゼンテーション品質の向上

**開発アプローチ**
- モジュール化された設計により、表示エンジンの差し替えを容易にする
- コアロジック（計算エンジン）とビジュアライゼーション層を分離
- パフォーマンスを考慮したハイブリッド実装（重い計算はサーバーサイド）

### 6.1.2 測量図処理技術

**自動処理と手動調整の組み合わせ**
- DWG/DXF形式からの座標情報の自動抽出
- PDFからのOCRと形状認識技術の組み合わせ
- ユーザーによる手動補正インターフェースの提供
- 抽出結果の検証と調整メカニズム

**必要なデータ連携**
- 緯度経度情報との紐付け
- 地形データ（標高）との統合
- 地域の都市計画情報との自動照合
- 規制情報データベースとの連携

### 6.1.3 計算処理アーキテクチャ

**バックエンド計算エンジン**
- 複雑な法規制計算（斜線制限、日影規制等）はサーバーサイドで実行
- 計算結果のキャッシュ機構による応答速度の最適化
- バッチ処理とリアルタイム処理の使い分け

**フロントエンド処理**
- 軽量な再計算と表示の更新
- インタラクティブな操作に対する即時フィードバック
- WebWorkerを活用した非同期処理

### 6.1.4 収益性試算エンジン

**パラメータ管理システム**
- スライダーベースの直感的なパラメータ調整UI
- プリセットによる一般的なシナリオの素早い適用
- 過去のプロジェクトからのパラメータ自動提案機能
- リアルタイムな市場データとの連携オプション

**シナリオ比較システム**
- 複数シナリオの同時保存と管理
- 差分ハイライト機能による比較の容易化
- 感度分析グラフによるパラメータ影響の可視化
- 最適パラメータの自動提案機能

**レポート生成システム**
- 印刷用高品質PDFレポート生成
- 複数シナリオの一括比較レポート
- カスタマイズ可能なレポートテンプレート
- 企業ロゴや連絡先情報の自動埋め込み

## 7. システム構成とディレクトリ構造

詳細なディレクトリ構造は `docs/directory_structure.md` で定義されています。本プロジェクトでは、技術的な層ではなく、ビジネス機能を中心としたディレクトリ構造を採用しています。

### 7.1 システム全体構成

```
/HinagoProject/
├── docs/                   # プロジェクトドキュメント
├── mockups/                # UIモックアップ
├── shared/                 # 共有型定義とAPIパス
├── frontend/               # フロントエンドアプリケーション
├── backend/                # バックエンドアプリケーション
└── scripts/                # ビルドスクリプトや開発用ツール
```

### 7.2 バックエンド構造概要

```
/backend/
├── src/
│   ├── common/            # 全機能で共有する共通コード
│   ├── features/          # 機能ごとにグループ化
│   │   ├── auth/          # 認証機能
│   │   ├── users/         # ユーザー管理機能
│   │   ├── properties/    # 物件管理機能
│   │   ├── volume-check/  # ボリュームチェック機能
│   │   └── profitability/ # 収益性試算機能
│   ├── config/           # アプリケーション設定
│   ├── db/               # データベース関連
│   └── app.ts            # アプリケーションエントリーポイント
└── tests/                # テスト
```

### 7.3 フロントエンド構造概要

```
/frontend/
├── public/              # 静的ファイル
└── src/
    ├── common/          # 共通コンポーネント・ユーティリティ
    ├── features/        # 機能ごとにグループ化
    │   ├── auth/        # 認証機能
    │   ├── dashboard/   # ダッシュボード機能
    │   ├── properties/  # 物件管理機能
    │   ├── volume-check/ # ボリュームチェック機能
    │   └── profitability/ # 収益性試算機能
    ├── app/             # アプリケーションのコア
    └── index.tsx        # エントリーポイント
```

### 7.4 アプリケーション層設計の原則

1. **単一責任の原則**: 各コンポーネントは明確に定義された単一の責任を持つ
2. **ディレクトリ=機能**: 各ディレクトリは特定のビジネス機能を表す
3. **共通コードの抽象化**: 複数の機能で使用されるコードは `common` ディレクトリに抽象化
4. **型定義の一元管理**: すべての型定義は `shared/index.ts` で管理
5. **APIパスの一元管理**: すべてのAPIパスは `shared/index.ts` で管理
6. **共有コードは上流へ**: 複数の機能でコードの共有が必要になった場合は、上位の共通層へ移動

## 8. 開発計画とマイルストーン

| フェーズ | 内容 | 期間 | ステータス |
|---------|------|------|----------| 
| フェーズ1 | 要件定義・技術選定 | 2週間 | 進行中 |
| フェーズ2 | モックアップ作成・ユーザーインターフェース設計 | 2週間 | 開始予定 |
| フェーズ3 | データモデル設計・API設計 | 2週間 | 未着手 |
| フェーズ4 | 基本機能実装（認証・物件管理） | 3週間 | 未着手 |
| フェーズ5 | 測量図アップロードと形状抽出機能実装 | 3週間 | 未着手 |
| フェーズ6 | ボリュームチェック機能実装（Three.js） | 3週間 | 未着手 |
| フェーズ7 | 3Dモデル生成・容積消化率計算機能実装 | 3週間 | 未着手 |
| フェーズ8 | テスト・バグ修正 | 2週間 | 未着手 |
| フェーズ9 | ベータリリース・フィードバック収集 | 2週間 | 未着手 |
| フェーズ10 | 改善・正式リリース | 2週間 | 未着手 |
| フェーズ11 | （オプション）Cesiumへの移行検討・POC | 3週間 | 未着手 |

## 9. 添付資料

- [ボリュームチェックページモックアップ](/mockups/volume-check.html) - 主要機能のモックアップ
- [物件登録ページモックアップ](/mockups/property-register.html) - 物件情報登録のモックアップ
- [収益性試算ページモックアップ](/mockups/profitability-analysis.html) - 収益性分析のモックアップ
- [ダッシュボードモックアップ](/mockups/dashboard.html) - ダッシュボード画面のモックアップ

## 10. データフロー図

### 10.1 測量図処理フロー

```
[測量図アップロード] → [形式判定] → [適切な処理経路選択]
    │
    ├→ [DWG/DXF処理] → [座標抽出] → [敷地形状生成]
    │
    ├→ [PDF処理] → [OCR/画像認識] → [境界線抽出] → [座標変換] → [敷地形状生成]
    │
    └→ [画像処理] → [画像認識] → [境界線抽出] → [座標変換] → [敷地形状生成]
                                                       │
                                                       V
[敷地情報入力] → [地理情報連携] → [規制情報取得] → [検証・調整UI] → [確定敷地データ]
```

### 10.2 3Dモデル生成フロー

```
[確定敷地データ] → [アセットタイプ選択] → [計算パラメータ設定]
                                          │
                                          V
[バックエンド] → [法規制適用計算] → [最大建築可能ボリューム算出] → [階別データ生成]
                                                                  │
                                                                  V
[フロントエンド] → [Three.js初期化] → [敷地モデル生成] → [建物モデル生成] → [3D表示]
                                                                        │
                                                                        V
                                                    [容積消化率計算] → [結果表示]
```

### 10.3 収益性分析フロー

```
[ボリュームチェック結果] → [アセットタイプ選択] → [収益パラメータ設定]
                                                   │
                                                   V
[収益計算エンジン] → [年間収益計算] → [長期キャッシュフロー予測] → [財務指標算出]
                                                                  │
                                                                  V
[シナリオ管理] ←────────────────────────────────────────┬──→ [結果表示]
      ↑                                               │
      │                                               V
      └───────────────────────────────── [感度分析] → [グラフ生成]
```

### 10.4 データ連携図

```
[福岡市都市計画API] ───┐
                      │
[国土地理院標高API] ───┼─→ [データ統合レイヤー] ←─┬─── [測量図処理エンジン]
                      │                       │
[建築基準法DB] ────────┘                       └─── [ユーザー入力データ]
                                               │
                                               V
               ┌─────────────────────── [建築ボリューム計算エンジン]
               │                               │
               V                               V
    [Three.js可視化エンジン] ←─────────── [結果分析エンジン]
               │                               │
               └───────────────┐               │
                              V               V
                     [ユーザーインターフェース/レポート生成]
```
